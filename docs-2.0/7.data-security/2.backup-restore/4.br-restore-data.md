# Use BR to restore data

If you use the BR to back up data, you can use it to restore the data to Nebula Graph. This article introduces how to use BR to restore data from backup files.

## Prerequisites

To restore data with BR, do a check of these:

- The BR is compiled. For more information, see [Backup & Restore](2.compile-br.md).

- The Nebula Graph services are ONLINE.

- Make sure that the topology of the Nebula Graph cluster is the same with that of the backup files, including the number of graphd, storaged, and metad processes, and the number of the graph spaces.

- Get the backup file names to do the restoration. In this example, `BACKUP_2020_12_21_01_17_53` is used.

- From the `nebula-metad.conf` and `nebula-storaged.conf` files, get the IP addresses and ports of the meta and the storage servers. In this example,
  - For the meta server: `192.168.8.161:9559`
  - For the storage server: `192.168.8.161:9779`
  > **NOTE**: Make sure that the actual IP addresses are used in the configuration files, but not `127.0.0.1`.

- Your account on the BR machine can perform SSH login to the meta and the storage servers without password. For how to configure, you can refer to [RedHat Docs](https://www.redhat.com/sysadmin/passwordless-ssh "Click to go to RedHat website"). This account must have the write permission to the installation directory of Nebula Graph. In this example, such an account named `nebula` on the BR machine is used.

- If the backup files are stored on Amazon S3, make sure that the S3 CLI client is installed and configured on meta servers, storage servers, and the BR machine. For more information, see [Using Amazon S3 with CLI](https://docs.amazonaws.cn/en_us/cli/latest/userguide/cli-services-s3.html "Click to go to AWS website").

- If the backup files are stored on Alibaba Cloud OSS, make sure that the ossutil is installed on meta servers, storage servers, and the BR machine. For more information, see [Download and install ossutil](https://www.alibabacloud.com/help/doc-detail/120075.htm#concept-303829 "Click to go to Alibaba Cloud website").
  > **NOTE**: If ossutil64 is used, create a symbolic link from ossutil64 to ossutil. For example, `ln -s /usr/local/bin/ossutil64 /usr/local/bin/ossutil`.

- If the backup files are stored in other store systems, make sure they have been moved to the meta and storage servers.

## Procedure

To restore data from some backup files:

1. Edit the configuration file as follows.

    ```yaml
    meta_nodes:
      - # Set the IP address and the port of one metad process
        addrs: "192.168.8.161:9559"
        # Set the absolute path of the Nebula Graph installation directory
        root: "/usr/local/nebula/"
        # Set the absolute path of the data directory of the metad process
        data: "/usr/local/nebula/data/meta"
        # Set the account of the BR machine that is authorized to SSH the meta server
        user: "nebula"
     #- # If more than one metad processes run, refer the preceding configuration to add more
     #- addrs: "192.168.8.161:9559"
     #  root: "/usr/local/nebula/"
     #  data: "/usr/local/nebula/data/meta"
     #  user: "nebula"
     #- addrs: "192.168.8.161:9559"
     #  root: "/usr/local/nebula/"
     #  data: "/usr/local/nebula/data/meta"
     #  user: "nebula"

    storage_nodes:
     - # Set the IP address and the port of one storaged process
       addrs: "192.168.8.161:9779"
       # Set the absolute path of the Nebula Graph installation directory
       root: "/usr/local/nebula/"
       # Set the absolute path of the data directory of the storaged process
       data: "/usr/local/nebula/data/storage"
       # Set the account of the BR machine that is authorized to SSH the storage server
       user: "nebula"
     #- If more than one storaged processes run, refer the preceding configuration to add more
     #- addrs: "192.168.8.161:9779"
     #  root: "/usr/local/nebula/"
     #  data: "/usr/local/nebula/data/storage"
     #  user: "nebula"
     #- addrs: "192.168.8.161:9779"
     #  root: "/usr/local/nebula/"
     #  data: "/usr/local/nebula/data/storage"
     #  user: "nebula"
     
     # Set the store directory for the backup files.
     # If the backup files are stored locally, set
    backend: "local:///absolute/path/to/the/store/directory"
     # If Alibaba Cloud OSS is used, set
     # backend: "oss://nebulabackup"
     # If Amazon S3 is used, set
     # backend: "s3://nebulabackup"
     # Set the backup files to be restored
    backup_name: "BACKUP_2020_12_21_01_17_53"
    ```

2. Change to the `nebula-storage/util/br/bin/` directory.

   ```bash
   cd nebula-storage/util/util/br/bin/
   ```

3. Restore data.

   ```bash
   ./br restore full --config "/absolute/path/to/the/restore/configuration/file.yaml`"
   ```
  
    Of this command:
  
     - `restore full`: Restores data.
     - `--config "/absolute/path/to/the/restore/configuration/file.yaml"`: Sets the absolute path of the configuration file.

    > **NOTE**: During the restoration process, if the leader changes, an error will occur.

    When the restoration is done, you can find the data in the `/data/storage` directory under the Nebula Graph installation directory.

4. Verify the data.

> **NOTE**: After restoration, if the `Storage Error: part: 2, error code: -3.` error occurs when you query the restored data, do a check of the status of the Storage Service. If necessary, restart the Storage Service.
