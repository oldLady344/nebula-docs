# Use BR to restore data

If you use the BR to back up data, you can use it to restore the data to Nebula Graph. This article introduces how to use the BR to restore data from backup files.

## Prerequisites

To restore data with the BR, do a check of these:

- The BR is compiled. For more information, see [Compile BR](2.compile-br.md).

- The Nebula Graph services are running and we recommend that the restoration is performed when the application request traffic is very low.

- Make sure that the target and the source Nebula Graph clusters have the same topology, which means that they have the exactly same number of hosts.

- Get the backup folder names to do the restoration. In this example, `BACKUP_2020_12_21_01_17_53` is used.

- From the `nebula-metad.conf` and `nebula-storaged.conf` files, get the IP addresses and ports of the meta and the storage servers. Both files are in the `nebula/installation/path/nebula/etc` directory. In this example,
  - For the meta server: `192.168.8.161:9559`
  - For the storage server: `192.168.8.161:9779`
  > **NOTE**: Make sure that the actual IP addresses instead of `127.0.0.1` are used in the configuration file.

- Your account on the BR machine can log on to the meta and the storage servers via SSH without a password. Here is a [configuration reference](http://alexander.holbreich.org/ssh-tunnel-without-password/ "Click and leave Nebula Graph Docs"). This account must have the write permission to the installation directory of Nebula Graph. In this example, such an account named `nebula` on the BR machine is used.

- If the backup files are stored on Amazon S3, make sure that the S3 CLI client is installed and configured on the meta servers, the storage servers, and the BR machine. For more information, see [Using Amazon S3 with CLI](https://docs.amazonaws.cn/en_us/cli/latest/userguide/cli-services-s3.html "Click to go to AWS website").

- If the backup files are stored on Alibaba Cloud OSS, make sure that the ossutil is installed on the meta servers, the storage servers, and the BR machine. For more information, see [Download and install ossutil](https://www.alibabacloud.com/help/doc-detail/120075.htm#concept-303829 "Click to go to Alibaba Cloud website").
  > **NOTE**: If ossutil64 is used, create a symbolic link from ossutil64 to ossutil. For example, run `ln -s /usr/local/bin/ossutil64 /usr/local/bin/ossutil`.

- If the backup files are stored locally, make sure they have been moved to the specified directory on the meta and the storage servers.

## Procedure

To restore data from some backup files:

1. Edit the configuration file as follows. You can find an example configuration in the `nebula-storage/util/br/` directory.

    ```yaml
    meta_nodes:
      - # Set the IP address and the port of one meta server
        addrs: "192.168.8.161:9559"
        # Set the absolute path of the Nebula Graph installation directory
        root: "/usr/local/nebula/"
        # Set the absolute path of the data directory of the metad process
        data: "/usr/local/nebula/data/meta"
        # Set the account of the BR machine that is authorized to log on to the meta server via SSH
        user: "nebula"
     #- # If more than one metad processes run, refer to the preceding configuration to add more
     #- addrs: "192.168.8.161:9559"
     #  root: "/usr/local/nebula/"
     #  data: "/usr/local/nebula/data/meta"
     #  user: "nebula"
     #- addrs: "192.168.8.161:9559"
     #  root: "/usr/local/nebula/"
     #  data: "/usr/local/nebula/data/meta"
     #  user: "nebula"

    storage_nodes:
     - # Set the IP address and the port of one storage server
       addrs: "192.168.8.161:9779"
       # Set the absolute path of the Nebula Graph installation directory
       root: "/usr/local/nebula/"
       # Set the absolute path of the data directory of the storaged process
       data: "/usr/local/nebula/data/storage"
       # Set the account of the BR machine that is authorized to log on to the storage server via SSH
       user: "nebula"
     #- If more than one storaged processes run, refer to the preceding configuration to add more
     #- addrs: "192.168.8.161:9779"
     #  root: "/usr/local/nebula/"
     #  data: "/usr/local/nebula/data/storage"
     #  user: "nebula"
     #- addrs: "192.168.8.161:9779"
     #  root: "/usr/local/nebula/"
     #  data: "/usr/local/nebula/data/storage"
     #  user: "nebula"
     
     # Set the directory where the backup files are located.
     # If the backup files are stored locally
    backend: "local:///absolute/path/to/the/store/directory"
     # If Alibaba Cloud OSS is used
     # backend: "oss://nebulabackup"
     # If Amazon S3 is used
     # backend: "s3://nebulabackup"
     # Set the backup files to be restored
    backup_name: "BACKUP_2020_12_21_01_17_53"
    ```

2. Run the command to change to the `nebula-storage/util/br/bin/` directory.

   ```bash
   cd nebula-storage/util/util/br/bin/
   ```

3. Run the command to restore data.

   ```bash
   ./br restore full --config "/absolute/path/to/the/restore/configuration/file.yaml"
   ```
  
   In this command:
  
     - `restore full`: Restores data.
     - `--config "/absolute/path/to/the/restore/configuration/file.yaml"`: Sets the absolute path of the configuration file.

    > **NOTE**: During the restoration process, if the leader changes, an error occurs. To prevent data corruption, when an error occurs, you must run the `br restore` command to perform the restoration again.

    When the restoration is successful, you can find the data in the `nebula/installation/path/data/storage` directory under the Nebula Graph installation directory.

4. Wait about several seconds until the metadata and the schema are synchronized, and then verify the data. For example, on the nebula-console, run [`SHOW STATS`](../../3.ngql-guide/7.general-query-statements/6.show/14.show-stats/) to verify the number of vertices and edges in the restored graph space.

   > **NOTE**: After restoration,
   >
   > - if no records are returned for the `USE <space_name>` statement, we recommend that you restart the Graph Service.
   > - if the `Storage Error: part: 2, error code: -3.` error occurs when you query the restored data, do a check of the status of the Storage Service. If necessary, restart the Storage Service.
